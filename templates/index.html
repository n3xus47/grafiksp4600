<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Grafik zmian pracowników</title>
  <link rel="stylesheet" href="/static/style.css?v={{ range(1000000, 9999999) | random }}&t={{ range(1000000, 9999999) | random }}">
  <link rel="manifest" href="/static/manifest.json?v={{ range(1000000, 9999999) | random }}">
  <meta name="theme-color" content="#d32f2f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Grafik SP4600">
</head>
<body{% if is_admin %} class="admin-user"{% endif %}>
  <!-- Kontener dla headera i panelu -->
  <div class="header-container">
    <header class="site-header">
      <div class="wrap header-bar">
        <div class="header-left">
          <button id="hamburger-menu" class="hamburger-menu-btn hamburger-trigger" aria-label="Menu funkcji" title="Menu funkcji">
            <div class="hamburger-icon">
              <span></span>
            </div>
          </button>
          <svg class="logo" viewBox="0 0 1552 1114" alt="Logo firmy" title="Grafik Stacji Paliw 4600">
            <path class="logo-path" d="m559.7 0.8c-138.4 0-257.2 101.9-276.5 240h596.3c52.2 0 103.1 20.9 139.8 57.5l196.2 196.1c83.4 83.5 236.8 94.9 336-4.1l-340.2-340.8-19.8-21.1c-83.3-82-194.9-128.3-313.7-128.3"/>
            <path class="logo-path" d="m239.9 280.8c-131.2 0-239.9 108.7-239.9 241.9 0 50.9 15.7 91.8 42.7 135.4-10.3-70.5 45.6-135.4 117.5-135.4h112.9c42.5 0 83.3 16.8 113.4 46.9l322.1 320.9 223.1 223.1c93.1-92.9 93.1-247.2 0-340.1l-223.1-223.4-148.2-148c-76.2-76.1-178.3-120-285.5-120"/>
            <path class="logo-path" fill-rule="evenodd" d="m808.3 280.8c10.1 18.7 15.5 39.8 15.5 59.5 0 64.7-52.3 117-115.8 117-63.8 0-115.9-52.3-115.9-117 0-19.7 5.4-40.8 16.8-59.5"/>
          </svg>
        </div>
        <!-- Panel nawigacji dnia - na środku headera -->
        <div class="header-center">
          <button id="shift-prev-day" class="nav-btn" aria-label="Poprzedni dzień">&#x25C0;</button>
          <div class="shift-date-info">
            <h2 id="shift-date-label">DZISIAJ</h2>
            <span id="shift-date-display">{{ today_date }}</span>
          </div>
          <button id="shift-next-day" class="nav-btn" aria-label="Następny dzień">&#x25B6;</button>
        </div>
        
        <div class="header-right">
          
          <a draggable="false" class="spotify-download-btn" href="/download" onclick="installPWA(); return false;">
            <span aria-hidden="true" class="spotify-btn-icon">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.995 8.745a.75.75 0 0 1 1.06 0L7.25 9.939V4a.75.75 0 0 1 1.5 0v5.94l1.195-1.195a.75.75 0 1 1 1.06 1.06L8 12.811l-.528-.528-.005-.005-2.472-2.473a.75.75 0 0 1 0-1.06"></path>
                <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13"></path>
              </svg>
            </span>
            <span class="spotify-btn-text">Pobierz aplikację</span>
          </a>
          <button id="theme-toggle" class="spotify-btn" aria-label="Przełącz motyw" title="Przełącz między trybem jasnym a ciemnym">
            <svg id="theme-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Spotify-style Function Panel -->
    <div id="hamburger-menu-panel" class="spotify-panel hidden">
    <div class="spotify-panel-content">
      <!-- Header z tytułem, filtrami, przyciskami funkcji i przyciskiem zamknięcia -->
      <header class="spotify-panel-header">
        <div class="spotify-panel-title-section">
          <div class="spotify-title-with-icon">
            <svg class="spotify-functions-icon" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <h1 class="spotify-panel-title">Funkcje</h1>
          </div>
          
          
          <!-- Przyciski funkcji przeniesione do headera -->
          <div class="spotify-function-buttons">
            {% if is_admin %}
            <!-- Przyciski dla admina -->
            <button id="menu-btn-swaps-admin" class="spotify-function-card" title="Skrzynka">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">SKRZYNKA</div>
              </span>
            </button>
            <button id="menu-btn-employees" class="spotify-function-card" title="Pracownicy">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">PRACOWNICY</div>
              </span>
            </button>
            {% else %}
            <!-- Przyciski dla zwykłych użytkowników -->
            <button id="menu-btn-swaps-user" class="spotify-function-card" title="Skrzynka">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">SKRZYNKA</div>
              </span>
            </button>
            <button id="menu-btn-unavailability" class="spotify-function-card" title="Niedyspozycja">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">NIEDYSPOZYCJA</div>
              </span>
            </button>
            <button id="menu-btn-shifts" class="spotify-function-card" title="Zmiany">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">ZMIANY</div>
              </span>
            </button>
            {% endif %}
            
            <!-- Przycisk ręcznej edycji dla admina -->
            {% if is_admin %}
            <button id="menu-btn-edit" class="spotify-function-card" title="Ręczna edycja">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">EDYCJA</div>
              </span>
            </button>
            {% endif %}
            
            <!-- Przyciski systemowe -->
            <button id="menu-btn-refresh" class="spotify-function-card" title="Odśwież cache">
              <span>
                <div class="spotify-function-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                  </svg>
                </div>
                <div class="spotify-function-text">ODŚWIEŻ</div>
              </span>
            </button>
            <form action="/logout" method="post" class="spotify-function-card-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
              <button type="submit" class="spotify-function-card logout-card" title="Wyloguj">
                <span>
                  <div class="spotify-function-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                  </div>
                  <div class="spotify-function-text">WYLOGUJ</div>
                </span>
              </button>
            </form>
          </div>
        </div>
        
        <!-- Przycisk X usunięty - burger menu służy do zamykania -->
      </header>

    </div>
    </div>
  </div>

  <main class="wrap">
    <div class="grid3-vertical">
      
      <!-- Panel zmian z nawigacją - NAD grafikiem -->
      <div class="daily-shifts-container">
        <section class="daily-shifts-bar dniowka-shift">
          <div class="shifts-content">
            <div class="shifts-section">
              <h3>DNIÓWKA</h3>
              <div id="shifts-dniowka">
                {% if shifts_today.dniowka %}
                  <ul>{% for name in shifts_today.dniowka %}<li>{{ name }}</li>{% endfor %}</ul>
                {% else %}<p class="muted">brak przypisań</p>{% endif %}
              </div>
            </div>
          </div>
        </section>
        
        <section class="daily-shifts-bar popoludniowka-shift">
          <div class="shifts-content">
            <div class="shifts-section">
              <h3>POPOŁUDNIÓWKA</h3>
              <div id="shifts-popoludniowka">
                {% if shifts_today.popoludniowka %}
                  <ul>{% for name in shifts_today.popoludniowka %}<li>{{ name }}</li>{% endfor %}</ul>
                {% else %}<p class="muted">brak przypisań</p>{% endif %}
              </div>
            </div>
          </div>
        </section>
        
        <section class="daily-shifts-bar nocka-shift">
          <div class="shifts-content">
            <div class="shifts-section">
              <h3>NOCKA</h3>
              <div id="shifts-nocka">
                {% if shifts_today.nocka %}
                  <ul>{% for name in shifts_today.nocka %}<li>{{ name }}</li>{% endfor %}</ul>
                {% else %}<p class="muted">brak przypisań</p>{% endif %}
              </div>
            </div>
          </div>
        </section>
        
        <!-- Panel akcji zmian - podział poziomy na 3 -->
        <div id="shifts-actions" class="shifts-actions hidden">
          <div class="horizontal-container">
            <div class="section top-section">
              <h2 id="edit-mode-status" style="display: block;">TRYB EDYCJI</h2>
            </div>
            <div class="section middle-section">
              <div class="draft-controls">
                <button id="toggle-draft-mode" class="btn btn-secondary" data-listener-added="true">Włącz tryb roboczy</button>
                <div class="draft-mode-controls hidden">
                  <button id="exit-draft-mode" class="btn btn-secondary">Wyłącz tryb roboczy</button>
                  <button id="save-draft-version" class="btn btn-warning">Zapisz wersję roboczą</button>
                  <button id="publish-draft-shifts" class="btn btn-success">Prześlij zmiany</button>
                </div>
              </div>
            </div>
            <div class="section bottom-section">
              <div class="edit-actions">
                <button id="save-shifts" class="btn">Zapisz</button>
                <button id="cancel-shifts" class="btn">Anuluj</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Środek: tabelka grafik -->
      <section class="center-panel center-panel-no-title main-panel">
        
        <div class="table-wrap">
          <table class="table"
                 id="grafik"
                 data-year="{{ view_year }}" 
                 data-month="{{ view_month }}" 
                 data-current-user="{{ current_emp_name or current_user }}"
                 data-emp-count="{{ employees|length }}"
                 data-days-count="{{ schedule_rows|length }}">
            <thead>
              <tr>
                <th class="col-date">data</th>
                <th class="col-day">Dzień</th>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns.pair_done %}
                    <th class="col-emp"><span class="rot">Ania i Bożena</span></th>
                    {% set ns.pair_done = true %}
                  {% elif emp.name in pair and ns.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <th class="col-emp"><span class="rot">{{ emp.display_name }}</span></th>
                  {% endif %}
                {% endfor %}
                {% if is_admin %}
                <th class="col-summary">licznik</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for row in schedule_rows %}
              <tr class="{% if row.is_off %}off-day{% endif %}{% if row.is_today %} today-row{% endif %}">
                <td class="col-date{% if row.is_today %} today{% endif %}">{{ row.dd }}</td>
                <td class="col-day{% if row.is_today %} today{% endif %}">{{ row.abbr }}</td>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns_row = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns_row.pair_done %}
                    {% set shift_value = shifts_by_date.get(row.date, {}).get('Ania i Bożena', '') %}
                    {% if shift_value == 'DNIOWKA' %}
                      {% set display_value = 'D' %}
                    {% elif shift_value == 'NOCKA' %}
                      {% set display_value = 'N' %}
                    {% elif shift_value %}
                      {% set display_value = shift_value %}
                    {% else %}
                      {% set display_value = '' %}
                    {% endif %}
                    <td class="col-emp slot{% if row.is_today %} today{% endif %}" data-date="{{ row.iso }}" data-employee="Ania i Bożena" data-value="{{ display_value }}" data-official-value="{{ display_value }}">{{ display_value }}</td>
                    {% set ns_row.pair_done = true %}
                  {% elif emp.name in pair and ns_row.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    {% set shift_value = shifts_by_date.get(row.date, {}).get(emp.name, '') %}
                    {% if shift_value == 'DNIOWKA' %}
                      {% set display_value = 'D' %}
                    {% elif shift_value == 'NOCKA' %}
                      {% set display_value = 'N' %}
                    {% elif shift_value %}
                      {% set display_value = shift_value %}
                    {% else %}
                      {% set display_value = '' %}
                    {% endif %}
                    <td class="col-emp slot{% if row.is_today %} today{% endif %}" data-date="{{ row.iso }}" data-employee="{{ emp.name }}" data-value="{{ display_value }}" data-official-value="{{ display_value }}">{{ display_value }}</td>
                  {% endif %}
                {% endfor %}
                {% if is_admin %}
                <td class="col-summary{% if row.is_today %} today{% endif %}">
                  <div class="summary-item dniowka-count">{{ row.shifts.DNIOWKA|length if row.shifts and row.shifts.DNIOWKA else 0 }}</div>
                  <div class="summary-item poludniowka-count">{{ row.shifts.POPOLUDNIOWKA|length if row.shifts and row.shifts.POPOLUDNIOWKA else 0 }}</div>
                  <div class="summary-item nocka-count">{{ row.shifts.NOCKA|length if row.shifts and row.shifts.NOCKA else 0 }}</div>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <!-- Edytor inline dla komórek -->
          <div id="slot-editor" class="slot-editor hidden">
            <div class="row">
              <button data-value="D" class="opt left">D</button>
              <button data-value="P" class="opt center">P</button>
              <button data-value="N" class="opt right">N</button>
            </div>
            <div class="row">
              <input type="text" id="opt-custom" placeholder="własne" maxlength="10" />
            </div>
            <!-- Panel wyboru godzin dla międzyzmiany -->
            <div id="p-hours-panel" class="p-hours-panel hidden">
              <div class="hours-inputs">
                <label>Start:</label>
                <input type="text" id="p-start-hour" placeholder="10" maxlength="2" />
                <label>Koniec:</label>
                <input type="text" id="p-end-hour" placeholder="22" maxlength="2" />
              </div>
              <button id="p-confirm" class="btn">OK</button>
            </div>
          </div>
          
          <!-- Składanie prośby inline -->
          <div id="swap-compose" class="swap-compose">
            <input id="swap-comment-inline" placeholder="komentarz do prośby" />
            <button id="swap-send-inline" class="btn">Wyślij prośbę</button>
          </div>
        </div>
      </section>

      <!-- Nawigator miesiąca pod tabelą -->
      <div class="month-navigation-below-table">
        <a class="nav-btn" href="/?year={{ prev_year }}&month={{ prev_month }}" aria-label="Poprzedni miesiąc">&#x25C0;</a>
        <span class="month-label">{{ month_label }}</span>
        <a class="nav-btn" href="/?year={{ next_year }}&month={{ next_month }}" aria-label="Następny miesiąc">&#x25B6;</a>
      </div>
    </div>
  </main>

  <!-- Modale - poza kontenerem paneli, na poziomie całej strony -->
  <!-- Edytor pracowników -->
  <div id="emp-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="emp-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Pracownicy</div>
      <div class="emp-list" id="emp-list"></div>
      <div class="emp-add">
        <input id="emp-name" placeholder="imię" />
        <input id="emp-code" placeholder="id" />
        <input id="emp-email" placeholder="email" type="email" />
        <button id="emp-add-btn" class="btn">Dodaj</button>
      </div>
    </div>
  </div>


  <!-- Skrzynka próśb o zamianę -->
  <div id="swap-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="swap-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Skrzynka</div>
      <div class="emp-add emp-add-right">
        <button id="swap-clear" class="btn swap-clear-btn">Wyczyść</button>
      </div>
      <div class="emp-list" id="swap-list"></div>
    </div>
  </div>

  <!-- Zunifikowany panel zmian -->
  <div id="shifts-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="shifts-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Zarządzanie zmianami</div>
      
      <!-- Wybór typu operacji -->
      <div class="shift-type-selector">
        <div class="shift-type-options">
          <label class="shift-type-option">
            <input type="radio" name="shift-type" value="swap" checked>
            <span class="shift-type-label">
              <strong>Zamiana</strong>
              <small>Wymień się zmianami z innym pracownikiem</small>
            </span>
          </label>
          <label class="shift-type-option">
            <input type="radio" name="shift-type" value="give">
            <span class="shift-type-label">
              <strong>Oddanie</strong>
              <small>Oddaj swoją zmianę innemu pracownikowi</small>
            </span>
          </label>
          <label class="shift-type-option">
            <input type="radio" name="shift-type" value="take">
            <span class="shift-type-label">
              <strong>Zabranie</strong>
              <small>Poproś o przejęcie czyjejś zmiany</small>
            </span>
          </label>
        </div>
      </div>
      
      <!-- Formularz zamiany -->
      <div id="swap-form" class="shift-form active">
        <div class="compose-section">
          <h4>Twoja zmiana</h4>
          <div class="emp-add">
            <input id="shifts-from-name" placeholder="Twoje imię" value="{{ current_emp_name or current_user }}" readonly />
            <select id="shifts-from-date">
              <option value="" disabled selected>Wybierz datę swojej zmiany</option>
            </select>
          </div>
        </div>
        
        <div class="compose-section">
          <h4>Zmiana do przejęcia</h4>
          <div class="emp-add">
            <select id="shifts-to-name">
              <option value="" disabled selected>Wybierz osobę</option>
              {% for emp in employees %}
                {% if emp.name != (current_emp_name or current_user) %}
                  <option value="{{ emp.name }}">{{ emp.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <select id="shifts-to-date">
              <option value="" disabled selected>Najpierw wybierz osobę</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Formularz oddania -->
      <div id="give-form" class="shift-form">
        <div class="compose-section">
          <h4>Twoja zmiana do oddania</h4>
          <div class="emp-add">
            <input id="shifts-give-from-name" placeholder="Twoje imię" value="{{ current_emp_name or current_user }}" readonly />
            <select id="shifts-give-from-date">
              <option value="" disabled selected>Wybierz datę swojej zmiany</option>
            </select>
          </div>
        </div>
        
        <div class="compose-section">
          <h4>Osoba do której oddajesz</h4>
          <div class="emp-add">
            <select id="shifts-give-to-name">
              <option value="" disabled selected>Wybierz osobę</option>
              {% for emp in employees %}
                {% if emp.name != (current_emp_name or current_user) %}
                  <option value="{{ emp.name }}">{{ emp.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      
      <!-- Formularz zabrania -->
      <div id="take-form" class="shift-form">
        <div class="compose-section">
          <h4>Osoba od której chcesz zabrać zmianę</h4>
          <div class="emp-add">
            <select id="shifts-take-from-name">
              <option value="" disabled selected>Wybierz osobę</option>
              {% for emp in employees %}
                {% if emp.name != (current_emp_name or current_user) %}
                  <option value="{{ emp.name }}">{{ emp.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <select id="shifts-take-from-date">
              <option value="" disabled selected>Najpierw wybierz osobę</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Komentarz (wspólny dla wszystkich formularzy) -->
      <div class="compose-section">
        <h4>Komentarz (opcjonalny)</h4>
        <div class="emp-add">
          <textarea id="shifts-comment" placeholder="Dodaj komentarz do prośby..." rows="3"></textarea>
        </div>
      </div>
      
      <!-- Przyciski akcji -->
      <div class="compose-actions">
        <button id="shifts-send" class="btn">Wyślij prośbę</button>
        <button id="shifts-cancel" class="btn btn-secondary">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- Skrypt JavaScript -->
  <script src="/static/app.js?v={{ range(1000000, 9999999) | random }}"></script>
  
  <!-- Inicjalizacja danych o zmianach -->
  <script>
    // Załaduj dane o zmianach z backendu
    const shiftsData = {{ shifts_by_date | tojson | safe }};
    
    // Przetwórz każdą datę
    Object.keys(shiftsData).forEach(date => {
      if (date === '_timestamp') return; // Pomiń klucz timestamp
      
      // Przetwórz każdego pracownika dla tej daty
      Object.keys(shiftsData[date]).forEach(employeeName => {
        const shiftType = shiftsData[date][employeeName];
        
        // Znajdź odpowiednią komórkę w tabeli
        const cell = document.querySelector(`[data-date="${date}"][data-employee="${employeeName}"]`);
        if (cell) {
          // Zaktualizuj komórkę typem zmiany
          const displayValue = shiftType === 'DNIOWKA' ? 'D' : shiftType === 'NOCKA' ? 'N' : shiftType;
          cell.textContent = displayValue;
          cell.dataset.value = shiftType;
          
          // Dodaj odpowiednią klasę dla stylowania
          cell.classList.remove('dniowka', 'nocka', 'custom-shift', 'poludniowka');
          if (shiftType === 'DNIOWKA') {
            cell.classList.add('dniowka');
          } else if (shiftType === 'NOCKA') {
            cell.classList.add('nocka');
          } else if (shiftType && shiftType.startsWith('P ')) {
            cell.classList.add('poludniowka');
          } else if (shiftType && shiftType.length > 0) {
            cell.classList.add('custom-shift');
          }
        }
      });
    });
  </script>

  <!-- Modal do zgłaszania niedyspozycji -->
  <div id="unavailability-modal" class="emp-editor" tabindex="-1">
    <div class="emp-container">
      <button type="button" id="unavailability-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Zgłoś niedyspozycje</div>
      
      <div class="unavailability-content">
        <div class="month-selector">
          <div class="month-navigation">
            <button type="button" id="unavailability-prev-month" class="nav-btn" aria-label="Poprzedni miesiąc">&#x25C0;</button>
            <span id="unavailability-month-label" class="month-label">Styczeń 2024</span>
            <button type="button" id="unavailability-next-month" class="nav-btn" aria-label="Następny miesiąc">&#x25B6;</button>
          </div>
          <input type="month" id="unavailability-month" readonly style="display: none;" />
        </div>
        
        <div class="calendar-container">
          <div id="unavailability-calendar" class="mini-calendar"></div>
        </div>
        
        <div class="selected-days">
          <h4>Wybrane dni:</h4>
          <div id="selected-days-list"></div>
        </div>
        
        <div class="unavailability-actions">
          <button id="unavailability-submit" class="btn">Wyślij zgłoszenie</button>
          <button id="unavailability-cancel" class="btn btn-secondary">Anuluj</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CSRF Token dla JavaScript -->
  <script>
    window.csrfToken = '{{ csrf_token }}';
  </script>
</body>
</html>