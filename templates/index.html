<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafik zmian pracowników</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="site-header">
    <div class="wrap header-bar">
      <div class="header-left">
        <img class="logo" src="{{ url_for('static', filename='PKN.WA.D.png') }}" alt="Logo firmy" />
      </div>
      <div class="header-center">
        <a class="nav-btn" href="/?year={{ prev_year }}&month={{ prev_month }}" aria-label="Poprzedni miesiąc">&#x25C0;</a>
        <span class="month-label">{{ month_label }}</span>
        <a class="nav-btn" href="/?year={{ next_year }}&month={{ next_month }}" aria-label="Następny miesiąc">&#x25B6;</a>
      </div>
      <div class="header-right">
        <span id="clock" aria-live="polite">Ładowanie...</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid3">
      <!-- Lewy panel 15% -->
      <section class="card">
        <h2 class="center">Dzisiejsza zmiana</h2>
        <div class="stack">
          <div>
            <h3>Dzienna</h3>
            <div id="list-d" aria-label="Lista pracowników na zmianie dziennej">
              {% if shifts_today.dniowka %}
                <ul>{% for name in shifts_today.dniowka %}<li>{{ name }}</li>{% endfor %}</ul>
              {% else %}<p class="muted">brak przypisań</p>{% endif %}
            </div>
          </div>
          <div>
            <h3>Nocna</h3>
            <div id="list-n" aria-label="Lista pracowników na zmianie nocnej">
              {% if shifts_today.nocka %}
                <ul>{% for name in shifts_today.nocka %}<li>{{ name }}</li>{% endfor %}</ul>
              {% else %}<p class="muted">brak przypisań</p>{% endif %}
            </div>
          </div>
        </div>
        <div class="logout-area">
          <form action="/logout" method="post">
            <button class="btn" type="submit">Wyloguj</button>
          </form>
        </div>
      </section>

      <!-- Środek 70%: tabelka grafik (wypełnia całą wysokość) -->
      <section class="card center-panel" style="--section-title-h: 0px">
        
        <div class="table-wrap">
          <table class="table"
                 id="grafik"
                 data-year="{{ view_year }}" 
                 data-month="{{ view_month }}" 
                 data-current-user="{{ current_emp_name or session.get('user_name','') }}"
                 data-shifts="{{ shifts_by_date | tojson | safe }}"
                 style="--emp-count: {{ employees|length }}; --days-count: {{ schedule_rows|length }};"
                 role="grid"
                 aria-label="Grafik zmian pracowników">
            <thead>
              <tr>
                <th class="col-date" scope="col">data</th>
                <th class="col-day" scope="col">dzień</th>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns = namespace(pair_done=false) %}
                {% for name in employees %}
                  {% if name in pair and not ns.pair_done %}
                    <th class="col-emp" scope="col"><span class="rot">Ania i Bożena</span></th>
                    {% set ns.pair_done = true %}
                  {% elif name in pair and ns.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <th class="col-emp" scope="col"><span class="rot">{{ name }}</span></th>
                  {% endif %}
                {% endfor %}
                <th class="col-day" scope="col">dzień</th>
                <th class="col-date" scope="col">data</th>
              </tr>
            </thead>
            <tbody>
              {% for row in schedule_rows %}
              <tr class="{% if row.is_off %}off-day{% endif %}">
                <td class="col-date">{{ row.dd }}</td>
                <td class="col-day">{{ row.abbr }}</td>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns_row = namespace(pair_done=false) %}
                {% for name in employees %}
                  {% if name in pair and not ns_row.pair_done %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="Ania i Bożena" role="gridcell" tabindex="0"></td>
                    {% set ns_row.pair_done = true %}
                  {% elif name in pair and ns_row.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="{{ name }}" role="gridcell" tabindex="0"></td>
                  {% endif %}
                {% endfor %}
                <td class="col-day">{{ row.abbr }}</td>
                <td class="col-date">{{ row.dd }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <!-- Edytor inline dla komórek -->
          <div id="slot-editor" class="slot-editor hidden" role="dialog" aria-label="Edytor komórki">
            <div class="row">
              <button data-value="D" class="opt left" aria-label="Ustaw zmianę dzienną">D</button>
              <button data-value="N" class="opt right" aria-label="Ustaw zmianę nocną">N</button>
            </div>
            <div class="row">
              <input type="text" id="opt-custom" placeholder="Własna wartość..." maxlength="10" aria-label="Własna wartość" />
            </div>
          </div>
          
          <!-- Składanie prośby inline -->
          <div id="swap-compose" class="swap-compose" role="dialog" aria-label="Składanie prośby o zamianę">
            <input id="swap-comment-inline" placeholder="komentarz do prośby" aria-label="Komentarz do prośby" />
            <button id="swap-send-inline" class="btn">Wyślij prośbę</button>
          </div>
        </div>
      </section>

      <!-- Prawy panel 15% -->
      <section class="card">
        <h2 class="center">Funkcje</h2>
        <div class="stack">
          {% if is_admin %}
          <button class="btn w100" disabled aria-label="Automatyczne generowanie grafiku (niedostępne dla użytkownika)">1) automatyczne generowanie grafiku (niedostępne dla użytkownika)</button>
          <button id="btn-edit" class="btn w100" aria-label="Ręczne wprowadzanie zmian">2) ręczne wprowadzanie zmian</button>
          <button id="btn-emps" class="btn w100" aria-label="Edycja pracowników">4) edycja pracowników</button>
          {% endif %}
          <button id="btn-swaps" class="btn w100" aria-label="Skrzynka próśb">3) skrzynka próśb</button>
          <button id="btn-compose" class="btn w100" aria-label="Wyślij prośbę o zamianę">5) wyślij prośbę o zamianę</button>
          <button id="btn-give" class="btn w100" aria-label="Oddaj swoją zmianę">6) oddaj swoją zmianę</button>
        </div>
        
        <!-- Przyciski akcji (widoczne tylko w trybie edycji) -->
        <div id="actions" class="actions" role="toolbar" aria-label="Akcje edycji">
          <button id="save" class="btn" aria-label="Zapisz zmiany">Zapisz</button>
          <button id="cancel" class="btn" aria-label="Anuluj zmiany">Anuluj</button>
        </div>
        
        <!-- Edytor pracowników -->
        <div id="emp-editor" class="emp-editor" role="dialog" aria-label="Edytor pracowników">
          <div class="emp-container">
            <button type="button" id="emp-close" class="emp-close" aria-label="Zamknij edytor pracowników">✕</button>
            <div class="emp-head">Pracownicy</div>
            <div class="emp-list" id="emp-list" role="list" aria-label="Lista pracowników"></div>
            <div class="emp-add">
              <input id="emp-name" placeholder="imię" aria-label="Imię pracownika" />
              <input id="emp-code" placeholder="id" aria-label="ID pracownika" />
              <button id="emp-add-btn" class="btn" aria-label="Dodaj pracownika">Dodaj</button>
            </div>
          </div>
        </div>

        <!-- Skrzynka próśb o zamianę -->
        <div id="swap-editor" class="emp-editor" role="dialog" aria-label="Skrzynka próśb o zamianę">
          <div class="emp-container">
            <button type="button" id="swap-close" class="emp-close" aria-label="Zamknij skrzynkę próśb">✕</button>
            <div class="emp-head">Skrzynka próśb</div>
            <div class="emp-add" style="justify-content:flex-end">
              <button id="swap-clear" class="btn" style="display:none" aria-label="Wyczyść wszystkie prośby">Wyczyść</button>
            </div>
            <div class="emp-list" id="swap-list" role="list" aria-label="Lista próśb o zamianę"></div>
          </div>
        </div>

        <!-- Formularz składania prośby o zamianę -->
        <div id="compose-editor" class="emp-editor" role="dialog" aria-label="Formularz składania prośby o zamianę">
          <div class="emp-container">
            <button type="button" id="compose-close" class="emp-close" aria-label="Zamknij formularz prośby">✕</button>
            <div class="emp-head">Wyślij prośbę o zamianę</div>
            
            <div class="compose-section">
              <h4>Twoja zmiana</h4>
              <div class="emp-add">
                <input id="compose-from-name" placeholder="Twoje imię" value="{{ current_emp_name or session.get('user_name','') }}" readonly aria-label="Twoje imię" />
                <select id="compose-from-date" aria-label="Wybierz datę swojej zmiany">
                  <option value="" disabled selected>Wybierz datę swojej zmiany</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Zmiana do przejęcia</h4>
              <div class="emp-add">
                <select id="compose-to-name" aria-label="Wybierz osobę">
                  <option value="" disabled selected>Wybierz osobę</option>
                  {% for n in employees %}
                    {% if n != (current_emp_name or session.get('user_name')) %}
                      <option value="{{ n }}">{{ n }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <select id="compose-to-date" aria-label="Wybierz datę zmiany">
                  <option value="" disabled selected>Najpierw wybierz osobę</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Komentarz (opcjonalny)</h4>
              <div class="emp-add">
                <textarea id="compose-comment" placeholder="Dodaj komentarz do prośby..." rows="3" aria-label="Komentarz do prośby"></textarea>
              </div>
            </div>
            
            <div class="compose-actions">
              <button id="compose-send" class="btn btn-primary" aria-label="Wyślij prośbę o zamianę">Wyślij prośbę</button>
            </div>
          </div>
        </div>

        <!-- Formularz oddawania zmiany -->
        <div id="give-editor" class="emp-editor" role="dialog" aria-label="Formularz oddawania zmiany">
          <div class="emp-container">
            <button type="button" id="give-close" class="emp-close" aria-label="Zamknij formularz oddawania">✕</button>
            <div class="emp-head">Oddaj swoją zmianę</div>
            
            <div class="compose-section">
              <h4>Twoja zmiana do oddania</h4>
              <div class="emp-add">
                <input id="give-from-name" placeholder="Twoje imię" value="{{ current_emp_name or session.get('user_name','') }}" readonly aria-label="Twoje imię" />
                <select id="give-from-date" aria-label="Wybierz datę swojej zmiany">
                  <option value="" disabled selected>Wybierz datę swojej zmiany</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Osoba do której oddajesz</h4>
              <div class="emp-add">
                <select id="give-to-name" aria-label="Wybierz osobę">
                  <option value="" disabled selected>Wybierz osobę</option>
                  {% for n in employees %}
                    {% if n != (current_emp_name or session.get('user_name')) %}
                      <option value="{{ n }}">{{ n }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Komentarz (opcjonalny)</h4>
              <div class="emp-add">
                <textarea id="give-comment" placeholder="Dodaj komentarz do prośby..." rows="3" aria-label="Komentarz do prośby"></textarea>
              </div>
            </div>
            
            <div class="compose-actions">
              <button id="give-send" class="btn btn-primary" aria-label="Oddaj zmianę">Oddaj zmianę</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Skrypt JavaScript -->
  <script src="/static/app.js"></script>
  
  <!-- Inicjalizacja danych o zmianach -->
  <script>
    // Funkcja do inicjalizacji danych o zmianach
    function initializeShiftsData() {
      try {
        // Pobierz dane z atrybutu data-shifts tabeli
        const table = document.getElementById('grafik');
        const shiftsData = JSON.parse(table.dataset.shifts || '{}');
        
        // Sprawdź czy dane są dostępne
        if (!shiftsData || typeof shiftsData !== 'object') {
          console.warn('Brak danych o zmianach lub nieprawidłowy format');
          return;
        }
        
        // Przetwórz każdą datę
        Object.keys(shiftsData).forEach(date => {
          if (date === '_timestamp') return; // Pomiń klucz timestamp
          
          // Przetwórz każdego pracownika dla tej daty
          Object.keys(shiftsData[date]).forEach(employeeName => {
            const shiftType = shiftsData[date][employeeName];
            
            // Znajdź odpowiednią komórkę w tabeli
            const cell = document.querySelector(`[data-date="${date}"][data-employee="${employeeName}"]`);
            if (cell) {
              // Zaktualizuj komórkę typem zmiany
              const displayValue = shiftType === 'DNIOWKA' ? 'D' : shiftType === 'NOCKA' ? 'N' : shiftType;
              cell.textContent = displayValue;
              cell.dataset.value = shiftType;
              
              // Dodaj klasę CSS dla typu zmiany
              cell.classList.remove('shift-d', 'shift-n', 'shift-custom');
              if (shiftType === 'DNIOWKA') {
                cell.classList.add('shift-d');
              } else if (shiftType === 'NOCKA') {
                cell.classList.add('shift-n');
              } else {
                cell.classList.add('shift-custom');
              }
            }
          });
        });
        
        console.log('Dane o zmianach zostały zainicjalizowane pomyślnie');
      } catch (error) {
        console.error('Błąd podczas inicjalizacji danych o zmianach:', error);
      }
    }
    
    // Uruchom inicjalizację po załadowaniu DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeShiftsData);
    } else {
      initializeShiftsData();
    }
  </script>
</body>
</html>