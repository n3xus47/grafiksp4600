<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafik zmian pracownik√≥w</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#d32f2f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Grafik SP4600" />
  <meta name="description" content="Aplikacja do zarzƒÖdzania grafikiem zmian pracownik√≥w" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/static/manifest.json" />
  
  <!-- Styles -->
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="site-header">
    <div class="wrap header-bar">
      <div class="header-left">
        <img class="logo" src="{{ url_for('static', filename='PKN.WA.D.png') }}" alt="Logo firmy" />
      </div>
      <div class="header-center">
        <a class="nav-btn" href="/?year={{ prev_year }}&month={{ prev_month }}" aria-label="Poprzedni miesiƒÖc">&#x25C0;</a>
        <span class="month-label">{{ month_label }}</span>
        <a class="nav-btn" href="/?year={{ next_year }}&month={{ next_month }}" aria-label="Nastƒôpny miesiƒÖc">&#x25B6;</a>
      </div>
      <div class="header-right">
        <span id="clock">≈Åadowanie...</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid3">
      <!-- Lewy panel 15% -->
      <section class="card">
        <h2 class="center">Dzi≈õ</h2>
        <div class="stack">
          <div>
            <h3>Dni√≥wka</h3>
            <div id="list-d">
              {% if shifts_today.dniowka %}
                <ul>{% for name in shifts_today.dniowka %}<li>{{ name }}</li>{% endfor %}</ul>
              {% else %}<p class="muted">brak przypisa≈Ñ</p>{% endif %}
            </div>
          </div>
          <div>
            <h3>Nocka</h3>
            <div id="list-n">
              {% if shifts_today.nocka %}
                <ul>{% for name in shifts_today.nocka %}<li>{{ name }}</li>{% endfor %}</ul>
              {% else %}<p class="muted">brak przypisa≈Ñ</p>{% endif %}
            </div>
          </div>
        </div>
        <!-- PWA Install Button -->
        <div class="pwa-install-area" style="margin-bottom: 1rem;">
          <button id="pwa-install-btn" class="btn w100" style="display: none;">
            üì± Zainstaluj aplikacjƒô
          </button>
        </div>
        
        <div class="logout-area">
          <form action="/logout" method="post">
            <button class="btn" type="submit">Wyloguj</button>
          </form>
        </div>
      </section>

      <!-- ≈örodek 70%: tabelka grafik (wype≈Çnia ca≈ÇƒÖ wysoko≈õƒá) -->
      <section class="card center-panel" style="--section-title-h: 0px">
        
        <div class="table-wrap">
          <table class="table"
                 id="grafik"
                 data-year="{{ view_year }}" 
                 data-month="{{ view_month }}" 
                 data-current-user="{{ current_emp_name or current_user }}"
                 style="--emp-count: {{ employees|length }}; --days-count: {{ schedule_rows|length }};">
            <thead>
              <tr>
                <th class="col-date">data</th>
                <th class="col-day">dzie≈Ñ</th>
                {% set pair = ['Ania','Bo≈ºena'] %}
                {% set ns = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns.pair_done %}
                    <th class="col-emp"><span class="rot">Ania i Bo≈ºena</span></th>
                    {% set ns.pair_done = true %}
                  {% elif emp.name in pair and ns.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <th class="col-emp"><span class="rot">{{ emp.name }}</span></th>
                  {% endif %}
                {% endfor %}
                <th class="col-day">dzie≈Ñ</th>
                <th class="col-date">data</th>
              </tr>
            </thead>
            <tbody>
              {% for row in schedule_rows %}
              <tr class="{% if row.is_off %}off-day{% endif %}">
                <td class="col-date">{{ row.dd }}</td>
                <td class="col-day">{{ row.abbr }}</td>
                {% set pair = ['Ania','Bo≈ºena'] %}
                {% set ns_row = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns_row.pair_done %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="Ania i Bo≈ºena"></td>
                    {% set ns_row.pair_done = true %}
                  {% elif emp.name in pair and ns_row.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="{{ emp.name }}"></td>
                  {% endif %}
                {% endfor %}
                <td class="col-day">{{ row.abbr }}</td>
                <td class="col-date">{{ row.dd }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <!-- Edytor inline dla kom√≥rek -->
          <div id="slot-editor" class="slot-editor hidden">
            <div class="row">
              <button data-value="D" class="opt left">D</button>
              <button data-value="N" class="opt right">N</button>
            </div>
            <div class="row">
              <input type="text" id="opt-custom" placeholder="w≈Çasne" maxlength="10" />
            </div>
          </div>
          
          <!-- Sk≈Çadanie pro≈õby inline -->
          <div id="swap-compose" class="swap-compose">
            <input id="swap-comment-inline" placeholder="komentarz do pro≈õby" />
            <button id="swap-send-inline" class="btn">Wy≈õlij pro≈õbƒô</button>
          </div>
        </div>
      </section>

      <!-- Prawy panel 15% -->
      <section class="card">
        <h2 class="center">Funkcje</h2>
        <div class="stack">
          {% if is_admin %}
          <button id="btn-swaps" class="btn w100">SKRZYNKA PR√ì≈öB</button>
          <button id="btn-emps" class="btn w100">EDYCJA PRACOWNIK√ìW</button>
          <button class="btn w100" disabled>GENEROWANIE GRAFIKU (NIEDOSTƒòPNE)</button>
          <button id="btn-edit" class="btn w100">RƒòCZNE WPROWADZANIE ZMIAN</button>
          {% else %}
          <button id="btn-swaps" class="btn w100">SKRZYNKA PR√ì≈öB</button>
          <button id="btn-compose" class="btn w100">WY≈öLIJ PRO≈öBƒò O ZAMIANƒò</button>
          <button id="btn-give" class="btn w100">ODDAJ SWOJƒÑ ZMIANƒò</button>
          {% endif %}
        </div>
        
        <!-- Przyciski akcji (widoczne tylko w trybie edycji) -->
        <div id="actions" class="actions">
          <button id="save" class="btn">Zapisz</button>
          <button id="cancel" class="btn">Anuluj</button>
        </div>
        
        <!-- Edytor pracownik√≥w -->
        <div id="emp-editor" class="emp-editor">
          <div class="emp-container">
            <button type="button" id="emp-close" class="emp-close" aria-label="Zamknij">‚úï</button>
            <div class="emp-head">Pracownicy</div>
            <div class="emp-list" id="emp-list"></div>
            <div class="emp-add">
              <input id="emp-name" placeholder="imiƒô" />
              <input id="emp-code" placeholder="id" />
              <button id="emp-add-btn" class="btn">Dodaj</button>
            </div>
          </div>
        </div>

        <!-- Skrzynka pr√≥≈õb o zamianƒô -->
        <div id="swap-editor" class="emp-editor">
          <div class="emp-container">
            <button type="button" id="swap-close" class="emp-close" aria-label="Zamknij">‚úï</button>
            <div class="emp-head">Skrzynka pr√≥≈õb</div>
            <div class="emp-add" style="justify-content:flex-end">
              <button id="swap-clear" class="btn" style="display:none">Wyczy≈õƒá</button>
            </div>
            <div class="emp-list" id="swap-list"></div>
          </div>
        </div>

        <!-- Formularz sk≈Çadania pro≈õby o zamianƒô -->
        <div id="compose-editor" class="emp-editor">
          <div class="emp-container">
            <button type="button" id="compose-close" class="emp-close" aria-label="Zamknij">‚úï</button>
            <div class="emp-head">Wy≈õlij pro≈õbƒô o zamianƒô</div>
            
            <div class="compose-section">
              <h4>Twoja zmiana</h4>
              <div class="emp-add">
                <input id="compose-from-name" placeholder="Twoje imiƒô" value="{{ current_emp_name or current_user }}" readonly />
                <select id="compose-from-date">
                  <option value="" disabled selected>Wybierz datƒô swojej zmiany</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Zmiana do przejƒôcia</h4>
              <div class="emp-add">
                <select id="compose-to-name">
                  <option value="" disabled selected>Wybierz osobƒô</option>
                  {% for emp in employees %}
                    {% if emp.name != (current_emp_name or current_user) %}
                      <option value="{{ emp.name }}">{{ emp.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <select id="compose-to-date">
                  <option value="" disabled selected>Najpierw wybierz osobƒô</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Komentarz (opcjonalny)</h4>
              <div class="emp-add">
                <textarea id="compose-comment" placeholder="Dodaj komentarz do pro≈õby..." rows="3"></textarea>
              </div>
            </div>
            
            <div class="compose-actions">
              <button id="compose-send" class="btn btn-primary">Wy≈õlij pro≈õbƒô</button>
            </div>
          </div>
        </div>

        <!-- Formularz oddawania zmiany -->
        <div id="give-editor" class="emp-editor">
          <div class="emp-container">
            <button type="button" id="give-close" class="emp-close" aria-label="Zamknij">‚úï</button>
            <div class="emp-head">Oddaj swojƒÖ zmianƒô</div>
            
            <div class="compose-section">
              <h4>Twoja zmiana do oddania</h4>
              <div class="emp-add">
                <input id="give-from-name" placeholder="Twoje imiƒô" value="{{ current_emp_name or current_user }}" readonly />
                <select id="give-from-date">
                  <option value="" disabled selected>Wybierz datƒô swojej zmiany</option>
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Osoba do kt√≥rej oddajesz</h4>
              <div class="emp-add">
                <select id="give-to-name">
                  <option value="" disabled selected>Wybierz osobƒô</option>
                  {% for emp in employees %}
                    {% if emp.name != (current_emp_name or current_user) %}
                      <option value="{{ emp.name }}">{{ emp.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div class="compose-section">
              <h4>Komentarz (opcjonalny)</h4>
              <div class="emp-add">
                <textarea id="give-comment" placeholder="Dodaj komentarz do pro≈õby..." rows="3"></textarea>
              </div>
            </div>
            
            <div class="compose-actions">
              <button id="give-send" class="btn btn-primary">Oddaj zmianƒô</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Service Worker Registration -->
  <script>
    // Rejestracja Service Worker i obs≈Çuga PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('Service Worker zarejestrowany pomy≈õlnie:', registration.scope);
            
            // Sprawd≈∫ aktualizacje
            registration.addEventListener('updatefound', function() {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nowa wersja dostƒôpna
                  if (confirm('Dostƒôpna jest nowa wersja aplikacji. Czy chcesz jƒÖ za≈Çadowaƒá?')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(function(error) {
            console.log('Rejestracja Service Worker nie powiod≈Ça siƒô:', error);
          });
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installBtn = document.getElementById('pwa-install-btn');

    window.addEventListener('beforeinstallprompt', function(e) {
      // Zapobiegnij automatycznemu wy≈õwietleniu promptu
      e.preventDefault();
      // Zapisz event do p√≥≈∫niejszego u≈ºycia
      deferredPrompt = e;
      // Poka≈º przycisk instalacji
      if (installBtn) {
        installBtn.style.display = 'block';
      }
    });

    // Obs≈Çuga klikniƒôcia przycisku instalacji
    if (installBtn) {
      installBtn.addEventListener('click', function() {
        if (deferredPrompt) {
          // Poka≈º prompt instalacji
          deferredPrompt.prompt();
          // Czekaj na wyb√≥r u≈ºytkownika
          deferredPrompt.userChoice.then(function(choiceResult) {
            if (choiceResult.outcome === 'accepted') {
              console.log('U≈ºytkownik zaakceptowa≈Ç instalacjƒô PWA');
            } else {
              console.log('U≈ºytkownik odrzuci≈Ç instalacjƒô PWA');
            }
            deferredPrompt = null;
            installBtn.style.display = 'none';
          });
        }
      });
    }

    // Ukryj przycisk instalacji gdy aplikacja jest ju≈º zainstalowana
    window.addEventListener('appinstalled', function() {
      console.log('PWA zosta≈Ça zainstalowana');
      if (installBtn) {
        installBtn.style.display = 'none';
      }
      deferredPrompt = null;
    });

    // Sprawd≈∫ czy aplikacja dzia≈Ça w trybie standalone (zainstalowana)
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      console.log('Aplikacja dzia≈Ça w trybie standalone');
      if (installBtn) {
        installBtn.style.display = 'none';
      }
    }
  </script>
  
  <!-- Skrypt JavaScript -->
  <script src="/static/app.js"></script>
  
  <!-- Inicjalizacja danych o zmianach -->
  <script>
    // Za≈Çaduj dane o zmianach z backendu
    const shiftsData = {{ shifts_by_date | tojson }};
    
    // Przetw√≥rz ka≈ºdƒÖ datƒô
    Object.keys(shiftsData).forEach(date => {
      if (date === '_timestamp') return; // Pomi≈Ñ klucz timestamp
      
      // Przetw√≥rz ka≈ºdego pracownika dla tej daty
      Object.keys(shiftsData[date]).forEach(employeeName => {
        const shiftType = shiftsData[date][employeeName];
        
        // Znajd≈∫ odpowiedniƒÖ kom√≥rkƒô w tabeli
        const cell = document.querySelector(`[data-date="${date}"][data-employee="${employeeName}"]`);
        if (cell) {
          // Zaktualizuj kom√≥rkƒô typem zmiany
          const displayValue = shiftType === 'DNIOWKA' ? 'D' : shiftType === 'NOCKA' ? 'N' : shiftType;
          cell.textContent = displayValue;
          cell.dataset.value = shiftType;
        }
      });
    });
  </script>
</body>
</html>