<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafik zmian pracowników</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#d32f2f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Grafik SP4600">
</head>
<body>
  <header class="site-header">
    <div class="wrap header-bar">
      <div class="header-left">
        <img class="logo" src="{{ url_for('static', filename='PKN.WA.D.png') }}" alt="Logo firmy" />
        <button class="pwa-btn" onclick="installPWA()" title="Zainstaluj aplikację">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          POBIERZ
        </button>
      </div>
      <div class="header-center">
        <a class="nav-btn" href="/?year={{ prev_year }}&month={{ prev_month }}" aria-label="Poprzedni miesiąc">&#x25C0;</a>
        <span class="month-label">{{ month_label }}</span>
        <a class="nav-btn" href="/?year={{ next_year }}&month={{ next_month }}" aria-label="Następny miesiąc">&#x25B6;</a>
      </div>
      <div class="header-right">
        <span id="clock">Ładowanie...</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid3-vertical">
      <!-- Środek: tabelka grafik (na górze) -->
      <section class="center-panel center-panel-no-title main-panel">
        
        <div class="table-wrap">
          <table class="table"
                 id="grafik"
                 data-year="{{ view_year }}" 
                 data-month="{{ view_month }}" 
                 data-current-user="{{ current_emp_name or current_user }}"
                 data-emp-count="{{ employees|length }}"
                 data-days-count="{{ schedule_rows|length }}">
            <thead>
              <tr>
                <th class="col-date">data</th>
                <th class="col-day">dzień</th>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns.pair_done %}
                    <th class="col-emp"><span class="rot">Ania i Bożena</span></th>
                    {% set ns.pair_done = true %}
                  {% elif emp.name in pair and ns.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    <th class="col-emp"><span class="rot">{{ emp.name }}</span></th>
                  {% endif %}
                {% endfor %}
                <th class="col-day">dzień</th>
                <th class="col-date">data</th>
                {% if is_admin %}
                <th class="col-summary">licznik</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for row in schedule_rows %}
              <tr class="{% if row.is_off %}off-day{% endif %}">
                <td class="col-date">{{ row.dd }}</td>
                <td class="col-day">{{ row.abbr }}</td>
                {% set pair = ['Ania','Bożena'] %}
                {% set ns_row = namespace(pair_done=false) %}
                {% for emp in employees %}
                  {% if emp.name in pair and not ns_row.pair_done %}
                    {% set shift_value = shifts_by_date.get(row.date, {}).get('Ania i Bożena', '') %}
                    {% if shift_value == 'DNIOWKA' %}
                      {% set display_value = 'D' %}
                    {% elif shift_value == 'NOCKA' %}
                      {% set display_value = 'N' %}
                    {% elif shift_value %}
                      {% set display_value = shift_value %}
                    {% else %}
                      {% set display_value = '' %}
                    {% endif %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="Ania i Bożena" data-value="{{ display_value }}">{{ display_value }}</td>
                    {% set ns_row.pair_done = true %}
                  {% elif emp.name in pair and ns_row.pair_done %}
                    {# skip duplicate from pair #}
                  {% elif emp.name == 'Maciej' %}
                    {# remove Maciej #}
                  {% else %}
                    {% set shift_value = shifts_by_date.get(row.date, {}).get(emp.name, '') %}
                    {% if shift_value == 'DNIOWKA' %}
                      {% set display_value = 'D' %}
                    {% elif shift_value == 'NOCKA' %}
                      {% set display_value = 'N' %}
                    {% elif shift_value %}
                      {% set display_value = shift_value %}
                    {% else %}
                      {% set display_value = '' %}
                    {% endif %}
                    <td class="col-emp slot" data-date="{{ row.iso }}" data-employee="{{ emp.name }}" data-value="{{ display_value }}">{{ display_value }}</td>
                  {% endif %}
                {% endfor %}
                <td class="col-day">{{ row.abbr }}</td>
                <td class="col-date">{{ row.dd }}</td>
                {% if is_admin %}
                <td class="col-summary">
                  <div class="summary-item dniowka-count">{{ row.shifts.DNIOWKA|length if row.shifts and row.shifts.DNIOWKA else 0 }}</div>
                  <div class="summary-item nocka-count">{{ row.shifts.NOCKA|length if row.shifts and row.shifts.NOCKA else 0 }}</div>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <!-- Edytor inline dla komórek -->
          <div id="slot-editor" class="slot-editor hidden">
            <div class="row">
              <button data-value="D" class="opt left">D</button>
              <button data-value="N" class="opt right">N</button>
            </div>
            <div class="row">
              <input type="text" id="opt-custom" placeholder="własne" maxlength="10" />
            </div>
          </div>
          
          <!-- Składanie prośby inline -->
          <div id="swap-compose" class="swap-compose">
            <input id="swap-comment-inline" placeholder="komentarz do prośby" />
            <button id="swap-send-inline" class="btn">Wyślij prośbę</button>
          </div>
        </div>
      </section>

      <!-- Kontener dla dwóch paneli bocznych -->
      <div class="panels-container">
        <!-- Lewy panel (pod grafikiem) -->
        <section class="card left-panel">
          <h2 class="center">Dziś</h2>
          <div class="stack">
            <div>
              <h3>Dniówka</h3>
              <div id="list-d">
                {% if shifts_today.dniowka %}
                  <ul>{% for name in shifts_today.dniowka %}<li>{{ name }}</li>{% endfor %}</ul>
                {% else %}<p class="muted">brak przypisań</p>{% endif %}
              </div>
            </div>
            <div>
              <h3>Nocka</h3>
              <div id="list-n">
                {% if shifts_today.nocka %}
                  <ul>{% for name in shifts_today.nocka %}<li>{{ name }}</li>{% endfor %}</ul>
                {% else %}<p class="muted">brak przypisań</p>{% endif %}
              </div>
            </div>
          </div>
          
          <!-- Przycisk wyloguj w lewym panelu -->
          <div class="logout-area">
            <form action="/logout" method="post">
              <button class="btn w100" type="submit">WYLOGUJ</button>
            </form>
          </div>

        </section>

        <!-- Prawy panel (na dole) -->
        <section class="card right-panel">
          <h2 class="center">Funkcje</h2>
          <div class="stack">
            {% if is_admin %}
            <button id="btn-swaps" class="btn w100">SKRZYNKA PRÓŚB</button>
            <button id="btn-emps" class="btn w100">EDYCJA PRACOWNIKÓW</button>
            <button class="btn w100" disabled>GENEROWANIE GRAFIKU (NIEDOSTĘPNE)</button>
            <button id="btn-edit" class="btn w100">RĘCZNE WPROWADZANIE ZMIAN</button>
            {% else %}
            <button id="btn-swaps" class="btn w100">SKRZYNKA PRÓŚB</button>
            <button id="btn-compose" class="btn w100">WYŚLIJ PROŚBĘ O ZAMIANĘ</button>
            <button id="btn-give" class="btn w100">ODDAJ SWOJĄ ZMIANĘ</button>
            {% endif %}
          </div>
          
          <!-- Przyciski akcji (widoczne tylko w trybie edycji) -->
          <div id="actions" class="actions">
            <button id="save" class="btn">Zapisz</button>
            <button id="cancel" class="btn">Anuluj</button>
          </div>

        </section>
      </div>
    </div>
  </main>

  <!-- Modale - poza kontenerem paneli, na poziomie całej strony -->
  <!-- Edytor pracowników -->
  <div id="emp-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="emp-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Pracownicy</div>
      <div class="emp-list" id="emp-list"></div>
      <div class="emp-add">
        <input id="emp-name" placeholder="imię" />
        <input id="emp-code" placeholder="id" />
        <button id="emp-add-btn" class="btn">Dodaj</button>
      </div>
    </div>
  </div>

  <!-- Skrzynka próśb o zamianę -->
  <div id="swap-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="swap-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Skrzynka próśb</div>
      <div class="emp-add emp-add-right">
        <button id="swap-clear" class="btn swap-clear-btn">Wyczyść</button>
      </div>
      <div class="emp-list" id="swap-list"></div>
    </div>
  </div>

  <!-- Formularz składania prośby o zamianę -->
  <div id="compose-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="compose-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Wyślij prośbę o zamianę</div>
      
      <div class="compose-section">
        <h4>Twoja zmiana</h4>
        <div class="emp-add">
          <input id="compose-from-name" placeholder="Twoje imię" value="{{ current_emp_name or current_user }}" readonly />
          <select id="compose-from-date">
            <option value="" disabled selected>Wybierz datę swojej zmiany</option>
          </select>
        </div>
      </div>
      
      <div class="compose-section">
        <h4>Zmiana do przejęcia</h4>
        <div class="emp-add">
          <select id="compose-to-name">
            <option value="" disabled selected>Wybierz osobę</option>
            {% for emp in employees %}
              {% if emp.name != (current_emp_name or current_user) %}
                <option value="{{ emp.name }}">{{ emp.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <select id="compose-to-date">
            <option value="" disabled selected>Najpierw wybierz osobę</option>
          </select>
        </div>
      </div>
      
      <div class="compose-section">
        <h4>Komentarz (opcjonalny)</h4>
        <div class="emp-add">
          <textarea id="compose-comment" placeholder="Dodaj komentarz do prośby..." rows="3"></textarea>
        </div>
      </div>
      
      <div class="compose-actions">
        <button id="compose-send" class="btn btn-primary">Wyślij prośbę</button>
      </div>
    </div>
  </div>

  <!-- Formularz oddawania zmiany -->
  <div id="give-editor" class="emp-editor">
    <div class="emp-container">
      <button type="button" id="give-close" class="emp-close" aria-label="Zamknij">✕</button>
      <div class="emp-head">Oddaj swoją zmianę</div>
      
      <div class="compose-section">
        <h4>Twoja zmiana do oddania</h4>
        <div class="emp-add">
          <input id="give-from-name" placeholder="Twoje imię" value="{{ current_emp_name or current_user }}" readonly />
          <select id="give-from-date">
            <option value="" disabled selected>Wybierz datę swojej zmiany</option>
          </select>
        </div>
      </div>
      
      <div class="compose-section">
        <h4>Osoba do której oddajesz</h4>
        <div class="emp-add">
          <select id="give-to-name">
            <option value="" disabled selected>Wybierz osobę</option>
            {% for emp in employees %}
              {% if emp.name != (current_emp_name or current_user) %}
                <option value="{{ emp.name }}">{{ emp.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div class="compose-section">
        <h4>Komentarz (opcjonalny)</h4>
        <div class="emp-add">
          <textarea id="give-comment" placeholder="Dodaj komentarz do prośby..." rows="3"></textarea>
        </div>
      </div>
      
      <div class="compose-actions">
        <button id="give-send" class="btn btn-primary">Oddaj zmianę</button>
      </div>
    </div>
  </div>

  <!-- Skrypt JavaScript -->
  <script src="/static/app.js"></script>
  
  <!-- Inicjalizacja danych o zmianach -->
  <script>
    // Załaduj dane o zmianach z backendu
    const shiftsData = {{ shifts_by_date | tojson }};
    
    // Przetwórz każdą datę
    Object.keys(shiftsData).forEach(date => {
      if (date === '_timestamp') return; // Pomiń klucz timestamp
      
      // Przetwórz każdego pracownika dla tej daty
      Object.keys(shiftsData[date]).forEach(employeeName => {
        const shiftType = shiftsData[date][employeeName];
        
        // Znajdź odpowiednią komórkę w tabeli
        const cell = document.querySelector(`[data-date="${date}"][data-employee="${employeeName}"]`);
        if (cell) {
          // Zaktualizuj komórkę typem zmiany
          const displayValue = shiftType === 'DNIOWKA' ? 'D' : shiftType === 'NOCKA' ? 'N' : shiftType;
          cell.textContent = displayValue;
          cell.dataset.value = shiftType;
          
          // Dodaj odpowiednią klasę dla stylowania
          cell.classList.remove('dniowka', 'nocka', 'custom-shift');
          if (shiftType === 'DNIOWKA') {
            cell.classList.add('dniowka');
          } else if (shiftType === 'NOCKA') {
            cell.classList.add('nocka');
          } else if (shiftType && shiftType.length > 0) {
            cell.classList.add('custom-shift');
          }
        }
      });
    });
  </script>
</body>
</html>